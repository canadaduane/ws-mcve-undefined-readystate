# ws-mcve-undefined-readystate
Minimal, Complete Verifiable Example of "Undefined readyState" error in ws websocket library

See https://github.com/websockets/ws/issues/1738

## Reproducing the Error

```
yarn install
yarn start
```

Then visit http://localhost:3000 in Firefox.

Note that this only appears to happen via Firefox-initiated websocket:

```
Server listening on 3000
upgrade
/Users/dujohnson/Projects/relm/server/sscce/node_modules/ws/lib/websocket.js:838
  websocket.readyState = WebSocket.CLOSING;
                       ^

TypeError: Cannot set property 'readyState' of undefined
    at Socket.socketOnClose (/Users/dujohnson/Projects/relm/server/sscce/node_modules/ws/lib/websocket.js:838:24)
    at Socket.emit (events.js:194:15)
    at TCP._handle.close (net.js:597:12)
error Command failed with exit code 1.
```

When opening a websocket via Chrome, an error is raised on the server:

```
Error [ERR_STREAM_WRITE_AFTER_END]: write after end
    at writeAfterEnd (_stream_writable.js:243:12)
    at Receiver.Writable.write (_stream_writable.js:291:5)
    at Socket.socketOnData (/Users/dujohnson/Projects/relm/server/sscce/node_modules/ws/lib/websocket.js:876:35)
    at Socket.emit (events.js:194:15)
    at addChunk (_stream_readable.js:284:12)
    at readableAddChunk (_stream_readable.js:265:11)
    at Socket.Readable.push (_stream_readable.js:220:10)
    at TCP.onStreamRead [as onread] (internal/stream_base_commons.js:94:17)
Emitted 'error' event at:
    at Receiver.receiverOnError (/Users/dujohnson/Projects/relm/server/sscce/node_modules/ws/lib/websocket.js:781:13)
    at Receiver.emit (events.js:189:13)
    at writeAfterEnd (_stream_writable.js:245:10)
    at Receiver.Writable.write (_stream_writable.js:291:5)
    [... lines matching original stack trace ...]
    at TCP.onStreamRead [as onread] (internal/stream_base_commons.js:94:17)
error Command failed with exit code 1.
```
